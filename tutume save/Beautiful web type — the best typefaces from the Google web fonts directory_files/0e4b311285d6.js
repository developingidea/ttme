window.angular.module("ajaxHandler",[]).config(function($httpProvider){$httpProvider.interceptors.push(function($q,$rootScope){return{"request":function(config){$rootScope.ajaxLoading=true;return config||$q.when(config);},"requestError":function(rejection){$rootScope.growlMessage("There was a problem connecting to ChangeTip. Sorry about that. Please try again later.","error");$rootScope.ajaxLoading=false;return $q.reject(rejection);},"response":function(response){$rootScope.ajaxLoading=false;return response||$q.when(response);},"responseError":function(rejection){var flashMessage=null,flashType="warn";$rootScope.ajaxLoading=false;if(rejection.config.bypassErrorInterceptor){return $q.reject(rejection);}
if(rejection.status==400){flashMessage="That won't work";if(rejection.data){if(rejection.data.monikers&&rejection.data.monikers.error){flashMessage=rejection.data.monikers.error;}else if(rejection.data.msg){flashMessage="That won't work: "+rejection.data.msg;}}}else if(rejection.status==403){flashMessage="Sorry, you don't have permission to do that.";}else if(rejection.status==422&&rejection.data&&rejection.data.msg){flashMessage=rejection.data.msg;}else if(rejection.status>=500){flashMessage="There was a problem on our side. Sorry about that. We were notified, and will fix it ASAP. Please try again later.";flashType="error";}
if(flashMessage){$rootScope.growlMessage(flashMessage,flashType);}
return $q.reject(rejection);}};});});window.angular.module("truncate",[]).filter("characters",function(){return function(input,chars,breakOnWord){if(isNaN(chars)){return input;}
if(chars<=0){return"";}
if(input&&input.length>=chars){input=input.substring(0,chars);if(!breakOnWord){var lastspace=input.lastIndexOf(" ");if(lastspace!==-1){input=input.substr(0,lastspace);}}else{while(input.charAt(input.length-1)==" "){input=input.substr(0,input.length-1);}}
return input+"...";}
return input;};}).filter("words",function(){return function(input,words){if(isNaN(words)){return input;}
if(words<=0){return"";}
if(input){var inputWords=input.split(/\s+/);if(inputWords.length>words){input=inputWords.slice(0,words).join(" ")+"...";}}
return input;};});window.angular.module("angular-growl",[]);window.angular.module("angular-growl").directive("growl",["$rootScope",function($rootScope){"use strict";return{restrict:"A",template:"<div class='growl'>"+"\t<div class='growl-item alert' ng-repeat='message in messages' ng-class='computeClasses(message)'>"+"\t\t<button type='button' class='close' ng-click='deleteMessage(message)'>&times;</button>"+"       <div ng-switch='message.enableHtml'>"+"           <div ng-switch-when='true' ng-bind-html='message.text'></div>"+"           <div ng-switch-default ng-bind='message.text'></div>"+"       </div>"+"\t</div>"+"</div>",replace:false,scope:true,controller:["$scope","$timeout","growl",function($scope,$timeout,growl){var onlyUnique=growl.onlyUnique();$scope.messages=[];function addMessage(message){$scope.messages.push(message);if(message.ttl&&message.ttl!==-1){$timeout(function(){$scope.deleteMessage(message);},message.ttl);}}
$rootScope.$on("growlMessage",function(event,message){var found;if(onlyUnique){window.angular.forEach($scope.messages,function(msg){if(message.text===msg.text&&message.severity===msg.severity){found=true;}});if(!found){addMessage(message);}}else{addMessage(message);}});$scope.deleteMessage=function(message){var index=$scope.messages.indexOf(message);if(index>-1){$scope.messages.splice(index,1);}};$scope.computeClasses=function(message){return{"alert-success":message.severity==="success","alert-error":message.severity==="error","alert-danger":message.severity==="error","alert-info":message.severity==="info","alert-warning":message.severity==="warn"};};}]};}]);window.angular.module("angular-growl").provider("growl",function(){"use strict";var _ttl=null,_enableHtml=false,_messagesKey="messages",_messageTextKey="text",_messageSeverityKey="severity",_onlyUniqueMessages=true;this.globalTimeToLive=function(ttl){_ttl=ttl;};this.globalEnableHtml=function(enableHtml){_enableHtml=enableHtml;};this.messagesKey=function(messagesKey){_messagesKey=messagesKey;};this.messageTextKey=function(messageTextKey){_messageTextKey=messageTextKey;};this.messageSeverityKey=function(messageSeverityKey){_messageSeverityKey=messageSeverityKey;};this.onlyUniqueMessages=function(onlyUniqueMessages){_onlyUniqueMessages=onlyUniqueMessages;};this.serverMessagesInterceptor=["$q","growl",function($q,growl){function checkResponse(response){if(response.data[_messagesKey]&&response.data[_messagesKey].length>0){growl.addServerMessages(response.data[_messagesKey]);}}
function success(response){checkResponse(response);return response;}
function error(response){checkResponse(response);return $q.reject(response);}
return function(promise){return promise.then(success,error);};}];this.$get=["$rootScope","$filter",function($rootScope,$filter){var translate;try{translate=$filter("translate");}catch(e){}
function broadcastMessage(message){if(translate){message.text=translate(message.text);}
$rootScope.$broadcast("growlMessage",message);}
function sendMessage(text,config,severity){var _config=config||{},message;message={text:text,severity:severity,ttl:_config.ttl||_ttl,enableHtml:_config.enableHtml||_enableHtml};broadcastMessage(message);}
function addWarnMessage(text,config){sendMessage(text,config,"warn");}
function addErrorMessage(text,config){sendMessage(text,config,"error");}
function addInfoMessage(text,config){sendMessage(text,config,"info");}
function addSuccessMessage(text,config){sendMessage(text,config,"success");}
function addServerMessages(messages){var i,message,severity,length;length=messages.length;for(i=0;i<length;i++){message=messages[i];if(message[_messageTextKey]&&message[_messageSeverityKey]){switch(message[_messageSeverityKey]){case"warn":severity="warn";break;case"success":severity="success";break;case"info":severity="info";break;case"error":severity="error";break;}
sendMessage(message[_messageTextKey],undefined,severity);}}}
function onlyUnique(){return _onlyUniqueMessages;}
return{addWarnMessage:addWarnMessage,addErrorMessage:addErrorMessage,addInfoMessage:addInfoMessage,addSuccessMessage:addSuccessMessage,addServerMessages:addServerMessages,onlyUnique:onlyUnique};}];});window.angular.module("ngDebounce",[]).factory("$debounce",function($timeout,$q){return function(func,wait,immediate){var timeout;var deferred=$q.defer();return function(){var context=this,args=arguments;var later=function(){timeout=null;if(!immediate){deferred.resolve(func.apply(context,args));deferred=$q.defer();}};var callNow=immediate&&!timeout;if(timeout){$timeout.cancel(timeout);}
timeout=$timeout(later,wait);if(callNow){deferred.resolve(func.apply(context,args));deferred=$q.defer();}
return deferred.promise;};};});window.angular.module("angularLoad",[]).service("angularLoad",["$document","$q","$timeout",function($document,$q,$timeout){function loader(createElement){var promises={};return function(url){if(typeof promises[url]==="undefined"){var deferred=$q.defer();var element=createElement(url);element.onload=element.onreadystatechange=function(e){$timeout(function(){deferred.resolve(e);});};element.onerror=function(e){$timeout(function(){deferred.reject(e);});};promises[url]=deferred.promise;}
return promises[url];};}
this.loadScript=loader(function(src){var script=$document[0].createElement("script");script.src=src;$document[0].body.appendChild(script);return script;});this.loadCSS=loader(function(href){var style=$document[0].createElement("link");style.rel="stylesheet";style.type="text/css";style.href=href;$document[0].head.appendChild(style);return style;});}]);var app=window.angular.module("changetip.factories",[]);app.factory("firstTipTracker",function(rewardService){return{firstTip:{},checkStatus:function(successCallback){var me=this;rewardService.getRewardInfo(this.firstTip,"first_tip",function(){me.firstTip.downAndToGo="";if(me.firstTip.countRemaining>0){var downIndex=(me.firstTip.countTotal-me.firstTip.countRemaining)-1,toGoIndex=me.firstTip.countRemaining-1;me.firstTip.downAndToGo=me.firstTip.rewardAmountDisplay[downIndex]+" rewarded! "+
me.firstTip.rewardAmountDisplay[toGoIndex]+" to go.";}
if(successCallback){successCallback();}});},endOfFirstTipFlow:function(){var me=this;return window.CHANGECOIN.user.first_tip_eligible&&!me.firstTip.eligible;}};});app.factory("pageSortSearchV2",["$http","$window",function($http,$window){function PSS(endPointSettings,sortCols,defaultSortColName){function isTimeCol(times,colName){return times.some(function(time){return colName.indexOf(time)!==-1;});}
this.init=function(endPointSettings,sortCols,defaultSortColName){this.url=endPointSettings.url;this.params=endPointSettings.params;this.rsProperty=endPointSettings.rsProperty;this.zeroOutStuff();if(!sortCols[0][2].hasOwnProperty("padding-left")){sortCols[0][2]["padding-left"]="15px";}
for(var i=0;i<sortCols.length;i++){var colName=sortCols[i][0],thisIsTheDefaultSort=colName===defaultSortColName,thisIsATimeColumn=isTimeCol(["time","date","_at"],colName);if(thisIsTheDefaultSort){this.activeSort=i;}
var styling=sortCols[i][2];this.cols.push({"column":colName,"columnDisplay":sortCols[i][1],"active":thisIsTheDefaultSort,"dir":(!thisIsATimeColumn&&thisIsTheDefaultSort)?0:1,"initialDir":thisIsATimeColumn?0:1,"style":(typeof styling=="object")?styling:{},"class":(typeof styling=="string")?styling:"","show":true});this.colsDict[colName]={active:thisIsTheDefaultSort,dir:(!thisIsATimeColumn&&thisIsTheDefaultSort)?0:1,initialDir:thisIsATimeColumn?0:1};}
this.activeSort=this.cols[this.activeSort];var params={"ordering":(this.activeSort.dir===1?"-":"")+this.activeSort.column};for(var p in this.params){if(this.params.hasOwnProperty(p)){params[p]=this.params[p];}}
this.params=params;};this.zeroOutStuff=function(){this.offset=0;this.cols=[];this.colsDict={};this.search="";this.total=0;this.first=0;this.last=0;this.loading=false;this.rs=null;};this.hideColumnHeader=function(columnIndex){this.cols[columnIndex].show=false;};this.showColumnHeader=function(columnIndex){this.cols[columnIndex].show=true;};this.updateColumnHeader=function(columnIndex,newColumnHeader){this.cols[columnIndex].columnDisplay=newColumnHeader;};this.updateColumnHeaderStyle=function(columnIndex,newColumnStyle){for(var attr in newColumnStyle){if(newColumnStyle.hasOwnProperty(attr)){this.cols[columnIndex].style[attr]=newColumnStyle[attr];}}};this.page=function(direction){var me=this;this.loading=true;this.rs=null;if(!!direction){this.url=me[direction]||this.url;}
var uri=$window.URI(this.url).removeSearch("ordering");this.csv=uri.toString()+".csv";uri.addSearch("ordering",(this.activeSort.dir===1?"-":"")+this.activeSort.column);this.url=uri.toString();return $http.get(this.url,{params:this.params}).success(function(response,status,headers,config){me.rs=response[me.rsProperty];me.total=response.count||0;me["next"]=response["next"];me["prev"]=response["previous"];me.loading=false;me.offset=urlSearch(config.url).page*10||0;me.params={};me.first=me.offset+1;me.last=Math.min(me.offset+10,me.total);}).error(function(){me.loading=false;});};this.sortBy=function(column){for(var s in this.cols){if(this.cols.hasOwnProperty(s)){if(this.cols[s].column===column){this.activeSort=this.cols[s];this.cols[s].active=true;this.cols[s].dir=(this.cols[s].dir+1)%2;}else{this.cols[s].active=false;this.cols[s].dir=this.cols[s].initialDir;}}}
if(this.colsDict.hasOwnProperty(column)){for(var c in this.colsDict){if(this.colsDict.hasOwnProperty(c)){if(c==column){this.colsDict[c].active=true;this.colsDict[c].dir=(this.colsDict[c].dir+1)%2;}else{this.colsDict[c].active=false;this.colsDict[c].dir=this.colsDict[c].initialDir;}}}}
return this.page();};this.inspectVisible=function(callback){if(this.rs){var len=this.rs.length;for(var i=0;i<len;i++){callback(this.rs[i]);}}};this.init(endPointSettings,sortCols,defaultSortColName);}
function urlSearch(url){var result={};var search=url.split("?")[1];if(!search){return{};}
var queryString=search.split("&");for(var i=0;i<queryString.length;i++){var temp=queryString[i].split("=");if(temp.length>1){result[temp[0]]=unescape(temp[1]);}}
return result;}
return{Instance:PSS};}]);app.factory("pageSortSearch",["$http",function($http){function PSS(endPointSettings,sortCols,defaultSortColName,initialPageSize){function isTimeCol(times,colName){return times.some(function(time){return colName.indexOf(time)!==-1;});}
this.init=function(endPointSettings,sortCols,defaultSortColName,initialPageSize){this.url=endPointSettings.url;this.params=endPointSettings.params;this.rsProperty=endPointSettings.rsProperty;this.limit=initialPageSize||15;this.zeroOutStuff();if(!sortCols[0][2].hasOwnProperty("padding-left")){sortCols[0][2]["padding-left"]="15px";}
for(var i=0;i<sortCols.length;i++){var colName=sortCols[i][0],thisIsTheDefaultSort=colName===defaultSortColName,thisIsATimeColumn=isTimeCol(["time","date","_at"],colName);if(thisIsTheDefaultSort){this.activeSort=i;}
var styling=sortCols[i][2];this.cols.push({"column":colName,"columnDisplay":sortCols[i][1],"active":thisIsTheDefaultSort,"dir":(!thisIsATimeColumn&&thisIsTheDefaultSort)?0:1,"initialDir":thisIsATimeColumn?0:1,"style":(typeof styling=="object")?styling:{},"class":(typeof styling=="string")?styling:"","show":true});this.colsDict[colName]={active:thisIsTheDefaultSort,dir:(!thisIsATimeColumn&&thisIsTheDefaultSort)?0:1,initialDir:thisIsATimeColumn?0:1};}
this.activeSort=this.cols[this.activeSort];};this.zeroOutStuff=function(){this.offset=0;this.cols=[];this.colsDict={};this.search="";this.total=0;this.first=0;this.last=0;this.loading=false;this.rs=null;};this.hideColumnHeader=function(columnIndex){this.cols[columnIndex].show=false;};this.showColumnHeader=function(columnIndex){this.cols[columnIndex].show=true;};this.updateColumnHeader=function(columnIndex,newColumnHeader){this.cols[columnIndex].columnDisplay=newColumnHeader;};this.updateColumnHeaderStyle=function(columnIndex,newColumnStyle){for(var attr in newColumnStyle){if(newColumnStyle.hasOwnProperty(attr)){this.cols[columnIndex].style[attr]=newColumnStyle[attr];}}};this.page=function(direction){var me=this,params;this.loading=true;this.rs=null;if(direction==="next"){this.offset=Math.min(this.offset+this.limit,this.total);}else if(direction==="prev"){this.offset=Math.max(this.offset-this.limit,0);}else{this.offset=0;}
this.first=this.offset+1;this.last=Math.min(this.offset+this.limit,this.total);params={"limit":this.limit,"offset":this.offset,"order_by":(this.activeSort.dir===1?"-":"")+this.activeSort.column,"search":this.search.slice(0,40)};for(var p in this.params){if(this.params.hasOwnProperty(p)){params[p]=this.params[p];}}
return $http.get(this.url,{params:params}).success(function(response){me.rs=response[me.rsProperty];me.total=response.total?response.total:response.meta?response.meta.total_count:0;me.last=Math.min(me.offset+me.limit,me.total);me.loading=false;}).error(function(){me.loading=false;});};this.sortBy=function(column){for(var s in this.cols){if(this.cols.hasOwnProperty(s)){if(this.cols[s].column===column){this.activeSort=this.cols[s];this.cols[s].active=true;this.cols[s].dir=(this.cols[s].dir+1)%2;}else{this.cols[s].active=false;this.cols[s].dir=this.cols[s].initialDir;}}}
if(this.colsDict.hasOwnProperty(column)){for(var c in this.colsDict){if(this.colsDict.hasOwnProperty(c)){if(c==column){this.colsDict[c].active=true;this.colsDict[c].dir=(this.colsDict[c].dir+1)%2;}else{this.colsDict[c].active=false;this.colsDict[c].dir=this.colsDict[c].initialDir;}}}}
return this.page();};this.inspectVisible=function(callback){if(this.rs){var len=this.rs.length;for(var i=0;i<len;i++){callback(this.rs[i]);}}};this.init(endPointSettings,sortCols,defaultSortColName,initialPageSize);}
return{Instance:PSS};}]);app.factory("jsonStorageService",["$window","$cookieStore",function($window,$cookieStore){function LocalStorageFacade(){if(!(this instanceof LocalStorageFacade)){return new LocalStorageFacade();}
this.get=function(key){var result=JSON.parse($window.localStorage.getItem(key));if(result===null){return void 0;}
return result;};this.put=function(key,value){$window.localStorage.setItem(key,JSON.stringify(value));};this.remove=function(key){$window.localStorage.removeItem(key);};}
function SessionCookieStorageFacade(){if(!(this instanceof SessionCookieStorageFacade)){return new SessionCookieStorageFacade();}
this.get=function(key){return $cookieStore.get(key);};this.put=function(key,value){$cookieStore.put(key,value);};this.remove=function(key){$cookieStore.remove(key);};}
try{if(!("localStorage"in $window)||$window["localStorage"]===null){var facade=new SessionCookieStorageFacade();facade.isLocalStorageSupported=false;return facade;}}catch(e){var facade=new SessionCookieStorageFacade();facade.isLocalStorageSupported=false;return facade;}
try{$window.localStorage.setItem("test","test");$window.localStorage.removeItem("test");}catch(e){var facade=new SessionCookieStorageFacade();facade.isLocalStorageSupported=false;return facade;}
var fac=new LocalStorageFacade();fac.isLocalStorageSupported=true;return fac;}]);app.factory("$FB",["$rootScope","$q",function($rootScope,$q){var fbLoaded=false;var deferred=$q.defer();var _fb={loaded:fbLoaded,resolved:deferred,_init:function(params){if(window.FB){angular.extend(window.FB,_fb);angular.extend(_fb,window.FB);if(!window.FB.loaded){_fb.loaded=true;window.FB.init(params);}
if(!$rootScope.$$phase){$rootScope.$apply();}}}};return _fb;}]);var app=window.angular.module("changetip.filters",[]);var SATOSHIS_IN_BTC=100000000;app.filter("specificCurrencyToReadableBTC",function(currencyConversionService){return function(input,abbrev){if(isNaN(input)||input===null){return 0;}
return currencyConversionService.specificCurrencyToReadableBTC(input,abbrev,"string_currency");};}).filter("specificCurrencyToReadableBTCKnox",function(currencyConversionService){return function(input,abbrev){if(isNaN(input)||input===null){return 0;}
return currencyConversionService.specificCurrencyToReadableBTCKnox(input,abbrev,"string_currency");};}).filter("fiatToBtcView",["currencyConversionService",function(currencyConversionService){var ccs=currencyConversionService;return function(fiatAmount){return ccs.getBTCView(ccs.toSatoshi(fiatAmount));};}]).filter("currencyToWithdrawBTC",function(moneyService){return function(input){return moneyService.currencyToWithdrawBTC(input);};}).filter("satoshiToReadableBTC",function(currencyConversionService){return function(satoshi,fullPrecision){if(isNaN(satoshi)){return 0;}
return currencyConversionService.satoshiToReadableBTC(satoshi,"html",null,fullPrecision===1);};}).filter("satoshiToCurrency",function(currencyConversionService){return function(satoshi){if(isNaN(satoshi)){return 0;}
return currencyConversionService.satoshiToCurrency(satoshi,"html");};}).filter("satoshiToCurrencyAsk",function(currencyConversionService){return function(satoshi){if(isNaN(satoshi)){return 0;}
return currencyConversionService.satoshiToCurrencyAsk(satoshi,"html");};}).filter("btcToCurrency",function(currencyConversionService){return function(btc){if(isNaN(btc)){return 0;}
var satoshis=btc*SATOSHIS_IN_BTC;return currencyConversionService.satoshiToCurrency(satoshis,"html");};}).filter("btcRateToCurrencyRate",function(currencyConversionService){return function(rate_text){return currencyConversionService.btcRateToCurrencyRate(rate_text);};}).filter("btcRateToCurrencyRateKnox",function(currencyConversionService){return function(rate_text){return currencyConversionService.btcRateToCurrencyRateKnox(rate_text);};}).filter("amountDisplay",function(currencyConversionService){return function(amount,fiat_display){return currencyConversionService.amountDisplay(amount,fiat_display);};}).filter("formatCurrency",function(currencyConversionService){return function(amount,abbreviation){return currencyConversionService.symbolizeAmount(amount,abbreviation);};}).filter("formatUSD",function(currencyConversionService){return function(usdAmount){return currencyConversionService.formatUSD(usdAmount);};}).filter("selectedBtcView",function(profileService){return function(profile){return profileService.getSelectedBtcView(profile);};}).filter("escape",function(){return window.escape;}).filter("nicetime",function(){return function(input){return moment.tz(input,"YYYY-MM-DDTHH:mm:ss","Etc/UTC").format("D MMM YYYY HH:mm UTC");};}).filter("utctime",function(){return function(input){return moment.tz(input,"YYYY-MM-DDTHH:mm:ss","Etc/UTC");};}).filter("ago",function(){return function(input){return moment.tz(input,"YYYY-MM-DDTHH:mm:ss","Etc/UTC").fromNow();};}).filter("abbreviatedAgo",function(){return function(input){var ago=moment.tz(input,"YYYY-MM-DDTHH:mm:ss","Etc/UTC").fromNow(),base="",baseRegex=/\d+|a few|a/,baseMatch=ago.match(baseRegex);if(baseMatch){base=baseMatch[0];if(base=="a"){base="1";}else if(base=="a few"){base="3";}}
if(ago.indexOf("day")>0){return base+"d";}else if(ago.indexOf("second")>0){return base+"s";}else if(ago.indexOf("minute")>0){return base+"m";}else if(ago.indexOf("hour")>0){return base+"h";}else if(ago.indexOf("month")>0){return base+"M";}else if(ago.indexOf("year")>0){return base+"y";}else{window.console.log("Unable to abbreviate time-ago input: "+ago);return"2s";}};}).filter("smartRound",function(){return function(input){if(isNaN(input)){return 0;}
var smart=parseFloat(input).toFixed(8);smart=smart.replace(/0+$/,"");smart=smart.replace(/\.$/,".00");if(smart.match(/\..$/)){smart=smart+"0";}
return smart;};}).filter("round6",function(){return function(input){if(isNaN(input)){return 0;}
return parseFloat(input).toFixed(6);};}).filter("smallDecimalRoundFormat",function($filter){return function(input,num_digits){if(num_digits===undefined){num_digits=2;}
var sign=1,fmt=[0.1,0.01,0.001,0.0001,0.00001,0.000001,0.0000001,0.00000001,0.000000001,0.0000000001];if(input<0){input=-1*input;sign=-1;}
num_digits-=1;var min_input=fmt[num_digits];if(min_input>input&&input>0.0000000001){var k=1;while(input<fmt[k]){k++;}
num_digits=k;}
if(sign==-1){sign="-";}else{sign="";}
return sign+$filter("number")(input,num_digits+1);};});app.filter("excerpt",function(){return function(s,length,ellipsis){s=s.toString();var substring=s.substring(0,length);if(s.length<=length||ellipsis===undefined){return substring;}
return s.substring(0,length)+ellipsis;};});app.filter("filterDeposits",function(){return function(activity){return activity.filter(function(item){return item.type&&item.type=="deposit";});};});app.filter("filterWithdrawals",function(){return function(activity){return activity.filter(function(item){return item.type&&item.type=="withdrawal";});};});app.filter('capitalize',function(){return function(input,all){var reg=(all)?/([^\W_]+[^\s-]*) */g:/([^\W_]+[^\s-]*)/;return(!!input)?input.replace(reg,function(txt){return txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase();}):'';};});var app=window.angular.module("changetip.services",[]),API="/v1/",SATOSHI=10e7,BTC_RATE_INVERSE=0.985,FORMAT_STRING="string",FORMAT_STRING_CURRENCY="string_currency",FORMAT_HTML="html";app.service("contactService",["$rootScope","$http","$analytics","encodingService",function($rootScope,$http,$analytics,encodingService){this.dispatchContact=function(from,subject,text,successCallback,errorCallback){$http({method:"POST",url:"/contact",data:encodingService.encode({"text":text,"email":from,"subject":subject}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(){$rootScope.growlMessage("Thank you for reaching out. We will be in touch, "+"probably within a day.","success");if(successCallback){successCallback();}}).error(function(response){if(errorCallback){errorCallback(response);}});$analytics.eventTrack("Contact Form Submit",subject);};}]);app.service("currencyService",["$window","$rootScope","$http","jsonStorageService",function($window,$rootScope,$http,jsonStorageService){$rootScope.currency=$window.CHANGECOIN.user.currency;this.getCurrency=function(){return $rootScope.currency;};this.setCurrency=function(currency){$rootScope.currency=currency;jsonStorageService.put("currency1",currency);};var savedCurrency;if(!$window.CHANGECOIN.user.authenticated){try{savedCurrency=jsonStorageService.get("currency1");}catch(e){$window.console.log("Error setting currency from local storage: "+e.message);}finally{if(savedCurrency){$rootScope.currency=savedCurrency;}}}
this.setCurrency($rootScope.currency);this.getCurrencies=function(scope){scope.currencies=window.CHANGECOIN.currencies;scope.currenciesHash={};for(var c in scope.currencies){if(scope.currencies.hasOwnProperty(c)){var currency=scope.currencies[c];scope.currenciesHash[currency.abbreviation]=currency;}}};this.getUSD=function(scope){$http.get(API+"currencies/?abbreviation=USD&max_age=60").success(function(data){if(data.objects){scope.usd=data.objects[0];}else{scope.usd=null;}}).error(function(data){scope.usd=null;window.console.log("error: "+JSON.stringify(data));});};}]);app.service("currencyConversionService",["$window","$rootScope","$filter",function($window,$rootScope,$filter){var me=this;this.getCurrency=function(abbreviation){var currencies=$window.CHANGECOIN.currencies.filter(function(c){return c.abbreviation==abbreviation;});return currencies&&currencies[0]||null;};this.satoshiToCurrency=function(satoshi,whichFormat){var c=$rootScope.currency;satoshi=parseInt(satoshi,10);if(c.abbreviation=="BTC"){return this.satoshiToReadableBTC(satoshi,whichFormat);}
var result=satoshi/SATOSHI/c.to_btc;if(whichFormat==FORMAT_HTML){result=this.symbol(c.abbreviation)+$filter("smallDecimalRoundFormat")(result);}else if(whichFormat==FORMAT_STRING){result=$filter("smallDecimalRoundFormat")(result);}else if(whichFormat==FORMAT_STRING_CURRENCY){result=c.abbreviation+$filter("smallDecimalRoundFormat")(result);}
return result;};this.satoshiToCurrencyAsk=function(satoshi,whichFormat){var c=$rootScope.currency;satoshi=parseInt(satoshi,10);if(c.abbreviation=="BTC"){return this.satoshiToReadableBTC(satoshi,whichFormat);}
var ex_rate=1.0/this.getCurrency("BTC").to_usd;var result=satoshi/SATOSHI/ex_rate;if(whichFormat==FORMAT_HTML){result=this.symbol(c.abbreviation)+$filter("smallDecimalRoundFormat")(result);}else if(whichFormat==FORMAT_STRING){result=$filter("smallDecimalRoundFormat")(result);}else if(whichFormat==FORMAT_STRING_CURRENCY){result=c.abbreviation+$filter("smallDecimalRoundFormat")(result);}
return result;};this.satoshiToReadableBTC=function(amount,whichFormat,btc_view,fullPrecision){if(!btc_view){btc_view=this.getBTCView(amount);}
amount=parseInt(amount,10);amount=btc_view.from_satoshi(amount,false);if(whichFormat==FORMAT_HTML){return this.htmlFormatAmount(amount,btc_view,fullPrecision);}else if(whichFormat==FORMAT_STRING){return this.stringFormatAmount(amount,btc_view,fullPrecision);}else if(whichFormat==FORMAT_STRING_CURRENCY){return this.stringCurrencyFormatAmount(amount,btc_view,fullPrecision);}else if(fullPrecision){return parseFloat(amount.toFixed(btc_view.full_precision));}
return amount;};this.formatUSD=function(usdValue){return this.symbol("USD")+$filter("smallDecimalRoundFormat")(usdValue);};this.getBTCView=function(amount){var user_btc_view=me.BTC_VIEWS[window.CHANGECOIN.user.btc_view];if(user_btc_view&&user_btc_view.to_satoshi){return user_btc_view;}
amount=parseInt(amount,10);if(Math.abs(amount)<10000){return me.BTC_VIEWS.bits;}
if(Math.abs(amount)<9999001){return me.BTC_VIEWS.bits;}
return me.BTC_VIEWS.btc;};this.specificCurrencyToReadableBTC=function(amount,abbrev,whichFormat){return this.satoshiToReadableBTC(this.toSatoshi(amount,abbrev),whichFormat);};this.specificCurrencyToReadableBTCKnox=function(amount,abbrev,whichFormat){var satoshis=this.toSatoshi(amount,abbrev);satoshis=Math.floor(satoshis*BTC_RATE_INVERSE);return this.satoshiToReadableBTC(satoshis,whichFormat);};this.satoshiToBTC=function(satoshi,htmlFormatted){var result=satoshi/SATOSHI;if(htmlFormatted){return this.htmlFormatAmount(result,this.BTC_VIEWS.btc);}
return result;};this.satoshiTomBTC=function(satoshi,htmlFormatted){var result=(satoshi/SATOSHI)*1000;if(htmlFormatted){return this.htmlFormatAmount(result,this.BTC_VIEWS.mbtc);}
return result;};this.satoshiTouBTC=function(satoshi,htmlFormatted){var result=(satoshi/10e4)*1000;if(htmlFormatted){return this.htmlFormatAmount(result,this.BTC_VIEWS.ubtc);}
return result;};this.satoshiToSatoshi=function(satoshi,htmlFormatted){if(htmlFormatted){return this.htmlFormatAmount(satoshi,this.BTC_VIEWS.satoshis);}
return satoshi;};this.toSatoshi=function(input,abbrev){var to_btc=$rootScope.currency.to_btc;if(abbrev){to_btc=$rootScope.currenciesHash[abbrev].to_btc;}
return Math.round(input*to_btc*SATOSHI);};this.toSatoshiFromBtcView=function(btcAmount,btcView){if(!btcView){btcView=this.getBTCView(btcAmount);}
return Math.round(btcAmount*btcView.to_satoshi);};this.toSatoshiFromCurrency=function(amount,fromCurrency){return Math.round(amount*fromCurrency.to_btc*SATOSHI);};this.toCurrencyFromCurrency=function(amount,fromCurrency,whichFormat){var satoshi=this.toSatoshiFromCurrency(amount,fromCurrency);return this.satoshiToCurrency(satoshi,whichFormat);};this.btcRateToCurrencyRate=function(rateText){var c=$rootScope.currency;var toBTCRate=parseFloat(rateText);var xRate=parseFloat(c.to_btc);var result=((toBTCRate*100000000)/(xRate*100000000));return result.toFixed(6);};this.btcRateToCurrencyRateKnox=function(rateText){var c=$rootScope.currency;var toBTCRate=parseFloat(rateText);var xRate=parseFloat(c.to_btc);var result=((toBTCRate*100000000)/(xRate*100000000));result=result*1.015;return result.toFixed(6);};this.htmlFormatAmount=function(amount,btc_view,fullPrecision){var result="<span",string_amount=this.stringFormatAmount(amount,btc_view,fullPrecision);if(btc_view.title){result+=" title=\""+btc_view.title+"\"";}
return result+">"+this.symbol("btc")+string_amount+" "+btc_view.abbrev+"</span>";};this.stringFormatAmount=function(amount,btc_view,fullPrecision){var precision=btc_view.precision;if(fullPrecision){precision=btc_view.full_precision;}
return $filter("number")(amount.toFixed(precision),precision);};this.stringCurrencyFormatAmount=function(amount,btc_view,fullPrecision){return this.stringFormatAmount(amount,btc_view,fullPrecision)+" "+btc_view.abbrev;};this.amountDisplay=function(amount,fiat_display){var display=this.satoshiToReadableBTC(amount,FORMAT_STRING_CURRENCY),btcView=this.getBTCView(amount);if(fiat_display.indexOf(btcView.abbrev)>0){return display;}
return display+" ("+fiat_display+")";};this.symbol=function(abbreviation){if(!abbreviation){abbreviation=$rootScope.currency.abbreviation;}
return"<i class=\"currency-"+abbreviation.toLowerCase()+"\"></i>";};this.symbolizeAmount=function(amount,abbreviation){return this.symbol(abbreviation)+$filter("currency")(amount,"");};this.BTC_VIEWS={"satoshis":{"precision":0,"full_precision":0,"abbrev":"satoshis","title":"satoshis, or bitcoin pennies","html_example":"12,345,678 <a><b>satoshis</b></a>","to_satoshi":1,"from_satoshi":this.satoshiToSatoshi},"bits":{"precision":2,"full_precision":2,"abbrev":"bits","title":"micro-bitcoins, or millionths of a bitcoin","html_example":"123,456.78 <a><b>bits</b></a>","to_satoshi":100,"from_satoshi":this.satoshiTouBTC},"ubtc":{"precision":2,"full_precision":2,"abbrev":"μBTC","title":"micro-bitcoins, or millionths of a bitcoin","html_example":"123,456.78 <a><b>μBTC</b></a>","to_satoshi":100,"from_satoshi":this.satoshiTouBTC},"mbtc":{"precision":4,"full_precision":5,"abbrev":"mBTC","title":"milli-bitcoins, or 1/1000ths of a bitcoin","html_example":"123.45678 <a><b>mBTC</b></a>","to_satoshi":100000,"from_satoshi":this.satoshiTomBTC},"btc":{"precision":5,"full_precision":8,"abbrev":"BTC","title":"","html_example":"0.12345678 <a><b>BTC</b></a>","to_satoshi":SATOSHI,"from_satoshi":this.satoshiToBTC},"default":{"html_example":"Calibrated according to magnitude (<a><b>default</b></a>)"}};}]);app.service("currencyGeneratorService",function($http,$rootScope,currencyConversionService,monikerService){this.generateAllAmounts=function(container,limitToAmount,successCallback){var me=this;var intermediateContainer={};container.allAmounts=[];monikerService.getAllMonikers(intermediateContainer,false,limitToAmount,function(){container.allAmounts=intermediateContainer.monikers.slice(0);me.appendLiteralAmounts(container.allAmounts,limitToAmount,successCallback);});};this.appendLiteralAmounts=function(container,limitToAmount,successCallback){var symbols=[["$","USD"],["£","GBP"],["€","EUR"]],bits=[["1 bit",100],["10 bits",1000],["100 bits",10000],["1 satoshi",1],["10 satoshis",10],["100 satoshis",100]],amount,satoshiValue;for(var i=25;i>=0.25;i=i-0.25){for(var c in symbols){if(symbols.hasOwnProperty(c)){amount=symbols[c][0]+i.toString();if(amount[amount.length-2]==="."){amount+="0";}
satoshiValue=currencyConversionService.toSatoshi(i,symbols[c][1]);if(!limitToAmount||satoshiValue<=limitToAmount){container.unshift({"name":amount,"satoshi_value":satoshiValue,"display":amount,"literal_amount":true});}}}}
for(var b in bits){if(bits.hasOwnProperty(b)){if(!limitToAmount||bits[b][1]<=limitToAmount){container.push({"name":bits[b][0],"satoshi_value":bits[b][1],"display":bits[b][0],"literal_amount":true});}}}
if(successCallback){successCallback(container);}};});app.service("moneyService",function($http,$rootScope,$timeout,currencyConversionService){var me=this;this.ccs=currencyConversionService;this._balance_btc_view=this.ccs.BTC_VIEWS.btc;this._balance_string="";this._satoshi_balance=0;this.setBalanceBTCView=function(satoshi_balance){this._balance_btc_view=this.ccs.getBTCView(satoshi_balance);this._balance_string=this.ccs.satoshiToCurrency(satoshi_balance,FORMAT_STRING);this._satoshi_balance=satoshi_balance;$rootScope.$emit("balance:update");};this.getBalanceBTCView=function(){return this._balance_btc_view;};this.loadBalance=function(scope,successCallback,getCachedValue){if($rootScope.loggedInUser){if($rootScope.balanceQueryInProcess){$timeout(function(){me.loadBalance(scope,successCallback,true);},100);return;}
if(getCachedValue&&!$rootScope.balanceQueryInProcess){scope.balance=$rootScope.balance;scope.btcBalanceSatoshi=$rootScope.balance;scope.usdBalanceSatoshi=$rootScope.usdBalanceSatoshi;scope.usdBalance=$rootScope.usdBalance;scope.showUSD=$rootScope.showUSD;me.setBalanceBTCView(scope.balance);scope.loading=false;return;}
if(!scope.balance){scope.balance=0;scope.btcBalanceSatoshi=0;}
if(!scope.usdBalanceSatoshi){scope.usdBalanceSatoshi=0;}
$rootScope.balanceQueryInProcess=true;$http({method:"GET",url:API+"wallet/money"}).success(function(data){$rootScope.balanceQueryInProcess=false;if(data.state&&data.state==="ok"){scope.balance=$rootScope.balance=data.balance;scope.btcBalanceSatoshi=$rootScope.btcBalanceSatoshi=data.balance;scope.usdBalanceSatoshi=$rootScope.usdBalanceSatoshi=data.usd_balance_as_satoshi;scope.usdBalance=$rootScope.usdBalance=data.usd_balance;scope.showUSD=$rootScope.showUSD=data.show_usd;me.setBalanceBTCView(scope.balance);}
scope.loading=false;if(successCallback){successCallback();}}).error(function(response){$rootScope.balanceQueryInProcess=false;window.console.log(response);});}};this.currencyToWithdrawBTC=function(amount,return_satoshis){if(typeof amount==="string"){amount=amount.replace(/\,/g,"");}
if(isNaN(amount)){return 0;}
if(amount===this._balance_string){amount=this._satoshi_balance;}else{if($rootScope.currency.abbreviation==="BTC"){amount=Math.round(amount*this._balance_btc_view.to_satoshi);}else{amount=this.ccs.toSatoshi(amount);}}
if(return_satoshis){return amount;}
return this.ccs.satoshiToReadableBTC(amount,FORMAT_STRING_CURRENCY,this._balance_btc_view,true);};});app.service("monikerService",function($http){var me=this;this.validateMatchesCSV=function(value){if(!value||value.trim().length===0){return"This field can't be blank";}
if(!XRegExp("\\p{L}+").test(value)){return"Invalid value. Try again!";}
if(XRegExp("[^\\p{L}\\d_,\\s]+").test(value)){return"Sorry! Alpha-numeric monikers only.";}
return null;};this.validateAmount=function(value){if(!value||value.trim().length===0){return"This field can't be blank";}
var re=/^\d*\.?\d+$/;if(!re.test(value)){return"Invalid value. Try again!";}
if(!parseFloat(value)){return"That'll never work.";}
return null;};this.updateMatchesCSV=function(id,value,errorCallback){var feedback=this.validateMatchesCSV(value);if(feedback){return feedback;}
return $http.put(API+"monikers/"+id+"/",{name:value}).error(function(data){if(data.hasOwnProperty("monikers")&&data.monikers.hasOwnProperty("id")){errorCallback(data.monikers.id);}else{errorCallback();}});};this.extractMonikerData=function(moniker_obj,container,limitToAmount){if(!limitToAmount||(limitToAmount&&moniker_obj.satoshi_value<=limitToAmount)){var names=[moniker_obj.name];var aliases=moniker_obj.matches_csv.split(",");for(var j in aliases){if(aliases.hasOwnProperty(j)&&moniker_obj.name!==aliases[j]){names.push(aliases[j]);}}
for(j in names){if(names.hasOwnProperty(j)&&names[j].indexOf("-")===-1){var n=names[j].trim(),parentheticals;for(var q in moniker_obj.candidate_qualifiers[n]){if(moniker_obj.candidate_qualifiers[n].hasOwnProperty(q)){if(moniker_obj.parentheticals){parentheticals=moniker_obj.parentheticals[n][moniker_obj.candidate_qualifiers[n][q]];}else{parentheticals='';}
container.monikers.push({"name":n,"value":moniker_obj.value,"satoshi_value":moniker_obj.satoshi_value,"currency":moniker_obj.currency.abbreviation,"display":moniker_obj.candidate_qualifiers[n][q]+" "+n+" "+
parentheticals});}}}}}};this.getAllMonikers=function(container,appendToList,limitToAmount,successCallback){$http({method:"GET",cache:true,url:"/v1/monikers?limit=10000&max_age=60"}).success(function(data){if(!appendToList){container.monikers=[];}
if(data.hasOwnProperty("objects")){for(var i in data.objects){if(data.objects.hasOwnProperty(i)){me.extractMonikerData(data.objects[i],container,limitToAmount);}}}
if(successCallback){successCallback();}}).error(function(response){window.console.log("error retrieving monikers: "+JSON.stringify(response));});};this.addMoniker=function(name,value,currencyId,imgUrl,successCallback){var meta={};if(imgUrl){meta['img_url']=imgUrl;}
return $http.post(API+"monikers/",{name:name,value:value,currency:"/v1/currencies/"+currencyId,meta:meta}).success(function(){successCallback();}).error(function(data){window.console.log("error: "+JSON.stringify(data));});};this.editMoniker=function(monikerId,name,value,currencyId,successCallback){return $http.put(API+"monikers/"+monikerId+"/",{name:name,value:value,currency:"/v1/currencies/"+currencyId}).success(function(){successCallback();}).error(function(data){window.console.log("error editing moniker: "+JSON.stringify(data));});};this.deleteMoniker=function(monikerId,callback){return $http["delete"](API+"monikers/"+monikerId+"/").success(function(){callback();}).error(function(data){window.console.log("error: "+JSON.stringify(data));});};});app.service("notificationService",["$window","$http",function($window,$http){this.off=function(channel,name,successCallback){successCallback=successCallback||$window.angular.noop;return $http.post(API+"notifications/",{name:name,channel:channel}).success(function(){successCallback();}).error(function(data){$window.console.log("error: "+JSON.stringify(data));});};this.on=function(channel,name,successCallback){successCallback=successCallback||$window.angular.noop;return $http["delete"](API+"notifications/"+channel+"/"+name).success(function(){successCallback();}).error(function(data){$window.console.log("error: "+JSON.stringify(data));});};}]);app.service("rewardService",function($http){this.getRewardInfo=function(container,rewardName,successCallback){$http({method:"GET",cache:false,url:"/v1/rewards/info?max_age=1&reward_name="+rewardName}).success(function(data){if(data[rewardName]){if(!container){container={};}
container.rewardAmount=data[rewardName].reward_amount;container.rewardAmountDisplay=data[rewardName].reward_amount_display;container.rewardChannel=data[rewardName].reward_channel;container.rewardCurrency=data[rewardName].reward_currency;container.countRemaining=data[rewardName].count_remaining;container.countTotal=data[rewardName].count_total;container.eligible=data[rewardName].eligible;if(successCallback){successCallback(container);}}else{window.console.log("Unexpected response: "+JSON.stringify(data));}}).error(function(response){window.console.log("Error getting reward info: "+JSON.stringify(response));});};});app.service("socialService",function($http,$analytics,currencyConversionService,$FB){var me=this;this.twitter={"profile":null,"friends":[],"errorLoadingFriends":false};this.create_guid=function(){function s4(){return Math.floor((1+Math.random())*0x10000).toString(16).substring(1);}
return s4()+s4()+"-"+s4()+"-"+s4()+"-"+
s4()+"-"+s4()+s4()+s4();};this.getTwitterFriends=function(callback){$http({method:"GET",cache:true,url:"/v1/social/twitter/friends"}).success(function(data){me.twitter.friends=data.friends;me.setTwitterFriendsPlaceholder();callback();}).error(function(response){me.twitter.errorLoadingFriends=response;if(response.hasOwnProperty("friends")){me.twitter.friends=response.friends;}
if(response.hasOwnProperty("errors")){$analytics.eventTrack("Error loading Twitter friends");window.console.log("error: "+JSON.stringify(response.errors));}
me.setTwitterFriendsPlaceholder();callback();});};this.setTwitterFriendsPlaceholder=function(){if(me.twitter.friends&&me.twitter.friends.length>0){me.twitter.friendsPlaceholder="Recipient (start typing)";me.twitter.friendsTooltip="";}else{if(me.twitter.errorLoadingFriends){var generalErrorMsg="Sadly, we've run into an issue retrieving your friends. ";if(me.twitter.errorLoadingFriends.state==="rate limit exceeded"){me.twitter.friendsPlaceholder="Twitter API error";me.twitter.friendsTooltip=generalErrorMsg+"It is likely temporary. Please try again later!";}else if(me.twitter.errorLoadingFriends.state==="protected account"){me.twitter.friendsPlaceholder="Recipient";me.twitter.friendsTooltip="";}else{me.twitter.friendsPlaceholder="Error retrieving friends list";me.twitter.friendsTooltip=generalErrorMsg+"Please try again later!";}}else{me.twitter.friendsPlaceholder="Recipient";me.twitter.friendsTooltip="";}}};this.fbOnLoad=function(container){$FB.getLoginStatus(function(response){if(response.status==="connected"){$FB.api("/me",function(response){if(response.id!=window.CHANGECOIN.user.facebook_uid){window.console.log("Not logged in as this user.");container.FBNotLoggedIn=true;}});}else{window.console.log("Not logged in.");container.FBNotLoggedIn=true;}},true);};this.fbSendTipMessage=function(container,tip_url,amount_display,sender,callback){if(!container.FBNotLoggedIn){$FB.ui({method:"send",link:tip_url+"?amount_display="+encodeURIComponent(amount_display)+"&sender="+encodeURIComponent(sender)},function(response){if(response&&response.success){callback(true);}else{callback(false);}});}};});app.service("synapseService",function($http,$rootScope,fingerprintService){this.data=null;this.accounts=[];this.allowed=true;var self=this;this.step=function(){if(!self.data||!self.data.customer||self.data.customer.permission==='UNVERIFIED'){return 1;}
return 2;};this.reload=function(){$http.get('/v2/synapsepay/info/',{bypassErrorInterceptor:true}).success(function(data){self.data=data;self.updateAccounts();$rootScope.$emit("synapsepay:data");});};this.reload();this.createCustomer=function(name,email,phone,callback){if(self.data.customer){return callback();}
$http.post('/v2/synapsepay/customer/',{legal_name:name,email:email,phone:phone,fingerprint:fingerprintService.fingerprint}).success(function(result){self.data.customer=result;self.updateAccounts();callback();}).error(callback);};this.updateCustomer=function(callback){$http.patch('/v2/synapsepay/customer/').success(function(result){self.data.customer=result.customer;self.updateAccounts();callback();}).error(callback);};this.updateAccounts=function(){var accounts=self.data&&self.data.customer&&self.data.customer.accounts||[];self.accounts=accounts.filter(function(account){return account.kind=='ACH-US';}).map(function(account){account.autoselect=true;return account;});};this.addAccount=function(routingNumber,acountNumber,callback){var url='/v2/synapsepay/customer/<CUST_ID>/account/'.replace('<CUST_ID>',self.data.customer.id);$http.post(url,{account_number:acountNumber,routing_number:routingNumber}).success(function(result){self.data.customer.accounts.push(result);self.updateAccounts();callback();}).error(callback);};this.withdrawBTC=function(account,amount,callback){var URL='/v2/synapsepay/customer/<CUST_ID>/account/<ACCT_ID>/withdrawal/btc/';var url=URL.replace('<CUST_ID>',self.data.customer.id).replace('<ACCT_ID>',account);self._withdraw(url,amount,callback);};this.withdrawUSD=function(account,amount,callback){var URL='/v2/synapsepay/customer/<CUST_ID>/account/<ACCT_ID>/withdrawal/usd/';var url=URL.replace('<CUST_ID>',self.data.customer.id).replace('<ACCT_ID>',account);self._withdraw(url,amount,callback);};this._withdraw=function(url,amount,callback){$http.post(url,{amount:amount}).success(function(){callback();}).error(callback);};});app.service("tipMeService",function($http,$analytics,$rootScope,debounce,currencyConversionService,encodingService){this.lastRequest=0;this.botResponseAvailable=function(container){return container.botResponseHtml&&container.botResponseHtml!=="loading...";};function setParseTipError(container,msg){container.parseTipError=msg;}
var debounced_setParseTipError=debounce(setParseTipError,1500);this.parseTip=function(container,tipSpecs,senderBalance,toSendOrNotToSend,successCallback,postSendCallback,errorCallback){if(!tipSpecs||!tipSpecs.textAmount){return;}
var me=this;this.lastRequest+=1;var orderRequests=this.lastRequest;container.parsingTip=true;container.sendingTip=toSendOrNotToSend;var firstParen=tipSpecs.textAmount.indexOf(" ("),trimmedMoniker=tipSpecs.textAmount.trim();if(firstParen!==-1){trimmedMoniker=tipSpecs.textAmount.substring(0,firstParen).trim();}
$http({method:"POST",cache:true,url:"/v1/tips/send_tipme",data:encodingService.encode({"receiver":tipSpecs.receiverId,"amount":trimmedMoniker,"comment":tipSpecs.comment,"send":toSendOrNotToSend}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(data){debounced_setParseTipError.cancel();if(orderRequests<me.lastRequest){return;}
container.parsingTip=false;container.parseTipError=null;container.botResponseHtml=data.bot_response_html;container.satoshisSpent=data.satoshi_amount;container.currentTipPocketCurrency=data.current_tip_pocket_currency;container.usdEndingBalance=container.usdBalanceSatoshi=data.usd_balance_satoshi;container.btcEndingBalance=container.btcBalanceSatoshi=data.btc_balance_satoshi;if(container.currentTipPocketCurrency=="USD"){container.usdEndingBalance=container.usdBalanceSatoshi-container.satoshisSpent;}else{container.btcEndingBalance=container.btcBalanceSatoshi-container.satoshisSpent;}
if(data.tx_id){container.satoshisSpent=0;container.botResponseHtml="loading...";container.txId=data.tx_id;$analytics.eventTrack("TipMe",{});container.sendingTip=false;if(postSendCallback){postSendCallback();}}
if(successCallback){successCallback();}}).error(function(response){if(orderRequests<me.lastRequest){return;}
container.parsingTip=false;container.sendingTip=false;container.parseTipError=null;container.btcEndingBalance="";container.usdEndingBalance="";if(response.hasOwnProperty("state")&&response.state&&response.hasOwnProperty("errors")&&response.errors.hasOwnProperty("text")&&response.errors.text){if(response.errors.text.indexOf("valid amount")<0){debounced_setParseTipError.cancel();setParseTipError(container,response.errors.text);}
else{debounced_setParseTipError(container,response.errors.text);}}else if(response.hasOwnProperty("state")&&response.state&&response.state=="unauthorized"){container.parseTipError="Try refreshing or logging in again.";}else{container.parseTipError="Please contact support@changetip.com. "+"An unexpected error has occurred";}
if(errorCallback){errorCallback(response);}});};});app.service("profileService",function($http,$analytics,$rootScope,$timeout,currencyConversionService){var me=this;this.getProfile=function(scope,profile_id){if($rootScope.profile){scope.profile=$rootScope.profile;return;}else if($rootScope.profileQueryInProcess){$timeout(function(){me.getProfile(scope,profile_id);},200);return;}
if(!profile_id){profile_id=window.CHANGECOIN.user.profile_id;}
if(profile_id&&!$rootScope.profile){$rootScope.profileQueryInProcess=true;return $http.get(API+"profiles/"+profile_id).success(function(data){$rootScope.profile=data;scope.profile=data;$rootScope.profileQueryInProcess=false;}).error(function(response){window.console.log("Error retrieving profile id "+profile_id+": "+JSON.stringify(response));$rootScope.profile=false;$rootScope.profileQueryInProcess=false;scope.profile=null;});}};this.updateProfile=function(newValue,oldValue){if(oldValue===undefined||oldValue===null||newValue===oldValue){return;}
$http({method:"PUT",url:API+"profiles/"+window.CHANGECOIN.user.profile_id,data:newValue}).error(function(response){window.console.log("error: "+JSON.stringify(response));});$analytics.eventTrack("Profile Edit");};this.getSelectedBtcView=function(profile){if(profile){for(var idx in profile.btc_view_choices){if(profile.btc_view_choices.hasOwnProperty(idx)){if(profile.btc_view===profile.btc_view_choices[idx][0]){return profile.btc_view_choices[idx][1];}}}}
return null;};this.checkOverTipLimit=function(satoshiAmount,profile){var currency=$rootScope.currenciesHash[profile.tx_max_currency];var btcAmount=currencyConversionService.satoshiToBTC(satoshiAmount);var btcLimit=profile.tx_max_amount*currency.to_btc;return btcAmount>btcLimit;};});app.service("tipService",function($http,$analytics,$rootScope,currencyConversionService,debounce,encodingService){this.lastRequest=0;this.botResponseAvailable=function(container){return container.botResponseHtml&&container.botResponseHtml!=="loading...";};this.setParseTipError=function(container,msg){container.parseTipError=msg;};var debounced_setParseTipError=debounce(this.setParseTipError,2000);this.validateMagicUrl=function(container,tipSpecs,senderBalance,successCallback,errorCallback){if(!tipSpecs||!tipSpecs.textAmount){return;}
var me=this;this.lastRequest+=1;var orderRequests=this.lastRequest;container.parsingTip=true;var firstParen=tipSpecs.textAmount.indexOf(" ("),trimmedMoniker=tipSpecs.textAmount.trim();if(firstParen!==-1){trimmedMoniker=tipSpecs.textAmount.substring(0,firstParen).trim();}
$http({method:"POST",cache:false,url:"/v1/tips/validate_magicurl",data:encodingService.encode({"receiver":tipSpecs.receiverChannelUsername,"amount":trimmedMoniker}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(data){debounced_setParseTipError.cancel();if(orderRequests<me.lastRequest){return;}
container.parsingTip=false;container.parseTipError=null;container.satoshisSpent=data.satoshi_amount;container.textAmount=data.text_amount;container.previewAmount=data.preview_amount;container.currentTipPocketCurrency=data.current_tip_pocket_currency;container.usdEndingBalance=container.usdBalanceSatoshi=data.usd_balance_satoshi;container.btcEndingBalance=container.btcBalanceSatoshi=data.btc_balance_satoshi;if(container.currentTipPocketCurrency=="USD"){container.usdEndingBalance=container.usdBalanceSatoshi-container.satoshisSpent;}else{container.btcEndingBalance=container.btcBalanceSatoshi-container.satoshisSpent;}
if(successCallback){successCallback();}}).error(function(response){debounced_setParseTipError.cancel();if(orderRequests<me.lastRequest){return;}
container.parsingTip=false;container.parseTipError=null;container.satoshisSpent=0;container.textAmount="";container.previewAmount="";container.btcEndingBalance="";container.usdEndingBalance="";if(response.hasOwnProperty("state")&&response.state&&response.hasOwnProperty("errors")&&response.errors.hasOwnProperty("text")&&response.errors.text){if(response.errors.text.indexOf("valid amount")>0){debounced_setParseTipError(container,response.errors.text);}else{container.parseTipError=response.errors.text;}}else{container.parseTipError="An unexpected error has occurred";}
if(errorCallback){errorCallback(response);}});};this.parseTip=function(container,tipSpecs,senderBalance,firstTipReward,toSendOrNotToSend,successCallback,postSendCallback,errorCallback){if(!tipSpecs||!tipSpecs.textAmount||!tipSpecs.receiverChannelUsername||!tipSpecs.channelName||tipSpecs.receiverChannelUsername=="@"){return;}
var me=this;this.lastRequest+=1;var orderRequests=this.lastRequest;container.parsingTip=true;container.sendingTip=toSendOrNotToSend;container.botResponseHtml="";container.responseHash=container.responseHash||container.twitterTipsSent||0;var firstParen=tipSpecs.textAmount.indexOf(" ("),trimmedMoniker=tipSpecs.textAmount.trim();if(firstParen!==-1){trimmedMoniker=tipSpecs.textAmount.substring(0,firstParen).trim();}
firstTipReward=firstTipReward||0;if(tipSpecs.channelName=="twitter"&&tipSpecs.receiverChannelUsername[0]=="@"){tipSpecs.receiverChannelUsername=tipSpecs.receiverChannelUsername.substr(1);}
$http({method:"POST",cache:true,url:"/v1/tips/send_tip",data:encodingService.encode({"receiver":tipSpecs.receiverChannelUsername,"amount":trimmedMoniker,"channel":tipSpecs.channelName,"first_tip_reward":firstTipReward,"response_hash":container.responseHash,"send":tipSpecs.channelName==="facebook"?null:toSendOrNotToSend}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(data){debounced_setParseTipError.cancel();if(orderRequests<me.lastRequest){return;}
container.parsingTip=false;container.parseTipError=null;container.botResponseHtml=data.bot_response_html;container.satoshisSpent=data.satoshi_amount;container.currentTipPocketCurrency=data.current_tip_pocket_currency;container.usdEndingBalance=container.usdBalanceSatoshi=data.usd_balance_satoshi;container.btcEndingBalance=container.btcBalanceSatoshi=data.btc_balance_satoshi;if(container.currentTipPocketCurrency=="USD"){container.usdEndingBalance=container.usdBalanceSatoshi-container.satoshisSpent;}else{container.btcEndingBalance=(firstTipReward+container.btcBalanceSatoshi)-container.satoshisSpent;}
if(data.tx_id){container.satoshisSpent=0;container.botResponseHtml="loading...";container.txId=data.tx_id;container.responseHash=data.tx_id;$analytics.eventTrack("Tip Your Friends",{"label":"tip sent on "+tipSpecs.channelName});container.sendingTip=false;if(postSendCallback){postSendCallback();}}
if(successCallback){successCallback();}}).error(function(response){debounced_setParseTipError.cancel();if(orderRequests<me.lastRequest){return;}
container.parsingTip=false;container.sendingTip=false;container.parseTipError=null;container.usdEndingBalance="";container.btcEndingBalance="";if(response.hasOwnProperty("state")&&response.state&&response.hasOwnProperty("errors")&&response.errors.hasOwnProperty("text")&&response.errors.text){if(response.errors.text.indexOf("eward account empty")>0){container.parseTipError="Supplies didn't last quite long enough for this tip to "+"qualify for the reward. We ran out of funds for this promotion.";}else if(response.state==="unauthorized"&&response.errors.text.indexOf("eligible")>0){container.parseTipError="Looks like you're not eligible for this reward. Your Twitter or Facebook "+"account may be too new or you may have already redeemed this reward. If you think "+"this is not right, please contact us at support@changetip.com. "+"We live to solve these kinds of problems.";}else if(response.state==="unauthorized"&&response.errors.text.indexOf("deactivated")>0){container.parseTipError="The first-tip promotion has expired.";}else if(response.errors.text.indexOf("valid amount")>0){debounced_setParseTipError(container,response.errors.text);}else{container.parseTipError=response.errors.text;}}else{container.parseTipError="An unexpected error has occurred";}
if(errorCallback){errorCallback(response);}});};});app.service("userService",function($http,$analytics,encodingService){this.getCurrentUser=function(scope){scope.loading=true;$http.get(API+"users/"+window.CHANGECOIN.user.id).success(function(data){scope.user=data;scope.loading=false;}).error(function(){scope.loading=false;});};this.setPassword=function(newPassword,newPasswordConfirm,successCallback,errorCallback){$http({method:"POST",url:API+"users/set-password",data:encodingService.encode({new_password:newPassword,new_password_confirm:newPasswordConfirm}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(successCallback).error(errorCallback);};this.updateEmail=function(userId,newEmail,isNewUser,successCallback,errorCallback){var data={email:newEmail};if(isNewUser){data["is_new_user"]=true;}
$http({method:"POST",url:API+"users/email",data:encodingService.encode(data),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(successCallback).error(errorCallback);$analytics.eventTrack("Email Edit");};});app.service("widgetService",["$rootScope","$http","encodingService",function($rootScope,$http,encodingService){this.snippet=function(){return $http.get(API+"widget/button/snippet");};this.snippets=function(csv_usernames){return $http({method:"POST",url:API+"widget/button/snippets",data:encodingService.encode({"unames":csv_usernames}),headers:{"Content-Type":"application/x-www-form-urlencoded"}});};}]);app.service("encodingService",function(){this.encode=function(data){var result=[];for(var key in data){if(data.hasOwnProperty(key)){result.push(encodeURIComponent(key)+"="+encodeURIComponent(data[key]));}}
return result.join("&");};});app.service("formEncodingService",function(){function objectToParameters(obj){var query=[];var o,v,k,key,name;for(name in obj){var value=obj[name];if(value instanceof Array){for(var i=0;i<value.length;i++){o={};v=value[i];key=name+"["+i+"]";o[key]=v;query.push(objectToParameters(o));}}else if(value instanceof Object){for(k in value){o={};v=value[key];key=name+"["+k+"]";o[key]=v;query.push(objectToParameters(o));}}else if(value!==undefined&&value!==null){var component=[encodeURIComponent(name),encodeURIComponent(value)].join("=");query.push(component);}}
return query.length?query.join("&"):"";}
return{fromObject:objectToParameters};});app.service("reportService",function($http){this.createReport=function(post_id,reason,comment,successCallback){return $http.post("/v2/posts/reports/",{post_id:post_id,reason:reason,comment:comment}).success(function(){successCallback();}).error(function(data){window.console.log("error: "+JSON.stringify(data));});};});app.service("vogogoService",function($rootScope,$http,$window,fingerprintService){var self=this;this.data=null;this.yearMonths=[{name:"January",abbr:"01"},{name:"February",abbr:"02"},{name:"March",abbr:"03"},{name:"April",abbr:"04"},{name:"May",abbr:"05"},{name:"June",abbr:"06"},{name:"July",abbr:"07"},{name:"August",abbr:"08"},{name:"September",abbr:"09"},{name:"October",abbr:"10"},{name:"November",abbr:"11"},{name:"December",abbr:"12"}];this.expirationYears=[];var date=new Date();for(var i=0;i<20;i++){var dateOption={};dateOption.name=date.getFullYear()+i;dateOption.abbr=dateOption.name.toString().substr(2);this.expirationYears.push(dateOption);}
this.occupations=[{"id":1,"name":"Accounting"},{"id":2,"name":"Administration"},{"id":3,"name":"Arts, Culture"},{"id":4,"name":"Business"},{"id":5,"name":"Communications"},{"id":6,"name":"Customer Service"},{"id":7,"name":"Education"},{"id":8,"name":"Energy, Utilities"},{"id":9,"name":"Engineering"},{"id":10,"name":"Finance"},{"id":11,"name":"Financial Services"},{"id":12,"name":"Government"},{"id":13,"name":"Health"},{"id":14,"name":"Hospitality"},{"id":15,"name":"Human Resources"},{"id":16,"name":"Internet"},{"id":17,"name":"Legal"},{"id":18,"name":"Manufacturing"},{"id":19,"name":"Marketing"},{"id":20,"name":"Non profit"},{"id":21,"name":"Recreation"},{"id":22,"name":"Religion"},{"id":23,"name":"Research"},{"id":24,"name":"Sales"},{"id":25,"name":"Sports, Fitness"},{"id":26,"name":"Student"},{"id":27,"name":"Crypto Exchange"},{"id":28,"name":"Crypto Merchant"},{"id":30,"name":"Advertising"},{"id":31,"name":"Agent (Travel Etc.)"},{"id":32,"name":"Architect"},{"id":33,"name":"Aviation"},{"id":34,"name":"Banking"},{"id":35,"name":"Brokerage"},{"id":36,"name":"Chiropractor"},{"id":37,"name":"Computers"},{"id":38,"name":"Controller"},{"id":39,"name":"Dean"},{"id":40,"name":"Dental"},{"id":41,"name":"Doctor"},{"id":42,"name":"Driver (Truck, Bus)"},{"id":43,"name":"Farmer"},{"id":44,"name":"Film"},{"id":45,"name":"Fireman"},{"id":46,"name":"Fisheries"},{"id":47,"name":"Flight Attendant"},{"id":48,"name":"Forestry"},{"id":49,"name":"Homemaker"},{"id":50,"name":"Insurance"},{"id":51,"name":"Journalism"},{"id":52,"name":"Judge"},{"id":53,"name":"Landscaper, Gardener"},{"id":54,"name":"Lawyer"},{"id":55,"name":"Medical"},{"id":56,"name":"Military"},{"id":57,"name":"Music"},{"id":58,"name":"Non Profit"},{"id":59,"name":"Nursing"},{"id":60,"name":"Paramedic"},{"id":61,"name":"Pilot"},{"id":62,"name":"Police"},{"id":63,"name":"Principal"},{"id":64,"name":"Professor"},{"id":65,"name":"Psychiatric"},{"id":66,"name":"Radiology"},{"id":67,"name":"Restaurant"},{"id":68,"name":"Retail"},{"id":69,"name":"Social Worker"},{"id":70,"name":"Teacher"},{"id":71,"name":"Technician"},{"id":72,"name":"Therapist"},{"id":73,"name":"Veterinarian"}];this.getOcupationById=function(id){return this.occupations.filter(function(occupation){return occupation.id==id;})[0];};this.getRegions=function(countryCode){var country=$window.iso3166.data[countryCode.toUpperCase()];if(!country){return[];}
return Object.keys(country.sub).map(function(r){return{code:r,name:country.sub[r].name,type:country.sub[r].type};}).sort(function(a,b){if(a.name>b.name){return 1;}
return-1;});};this.getRegion=function(regionCode){var countryCode=regionCode.substr(0,2);var regions=self.getRegions(countryCode);var result=regions.filter(function(r){return r.code==regionCode;});return result.length>0?result[0]:null;};this.getCardBrand=function(cardNumber){var leadingChar=(cardNumber||"").charAt(0);if(leadingChar==="4"){return"visa";}
if(leadingChar==="5"){return"mastercard";}
return null;};this._cardCache={};this.getCardInfo=function(cardNumber,callback){if(!cardNumber||cardNumber.length<6){callback('invalid');}
var number=cardNumber.substr(0,6);if(typeof(self._cardCache[number])!=="undefined"){return callback(null,this._cardCache[number]);}
$http({method:"GET",url:'https://www.binlist.net/json/'+number,bypassErrorInterceptor:true,headers:{'X-CSRFToken':undefined}}).success(function(data){delete data['bin'];delete data['card_category'];delete data['query_time'];delete data['sub_brand'];self._cardCache[number]=data;callback(null,data);}).error(function(){self._cardCache[number]=null;callback('not found');});};this.depositLimit=function(){if(!self.data){return 0;}
return Math.min(Number(self.data.limits.allow[1]),Number(self.data.limits.allow[3]),Number(self.data.limits.allow[7]));};this.getCustomer=function(data){var customer=self.data.customer;if(!self.data||!customer){return null;}
var fields=["address_country","address_state","cell_phone","address_street_1","address_city","address_postal_code"];for(var i=0;i<fields.length;i++){if(data[fields[i]]!==self.data.customer[fields[i]]){console.log('Esto es diferente',data[fields[i]],self.data.customer[fields[i]],fields[i]);return null;}}
return self.data.customer;};this.createCustomer=function(customer,callback){var data=angular.copy(customer);data.device_id=fingerprintService.fingerprint;var $apiCall=self.data.customer?$http.patch:$http.post;$apiCall.bind($http);$apiCall('/v2/vogogo/customer/',data).success(function(resp){self.data.customer=resp;callback(null,resp);}).error(callback);};this.has_fake_address=function(){return!!(self.data.customer&&self.data.customer.address_street_1=='33 Royal Street - APPROVED');};this.createCard=function(customer,card,callback){var form={"customer_id":customer.id,"card_number":card.number,"expiry_date_month":card.exp_month,"expiry_date_year":card.exp_year};["first_name","last_name","address_postal_code","address_country","address_street_1","address_city","address_state"].forEach(function(arg){form[arg]=customer[arg];});$window.Vogogo.setMerchantId(self.data.merchant_id);$window.onVogogoResponse=function onVogogoResponse(data){self._addCardCT(customer,card,data.id,callback);};$window.callback=function onVogogoError(data){callback({'detail':'We were unable to add your card. Please try again later.','error':data});};$window.Vogogo.getCardId(form,$window.onVogogoResponse);};this._addCardCT=function(customer,card,cardId,callback){var url='/v2/vogogo/customer/<CUST_ID>/card/'.replace('<CUST_ID>',customer.id);$http.post(url,{'brand':self.getCardBrand(card.number),'acct_id':cardId,'cvc':card.cvc,'iin':card.iin}).success(function(resp){resp.autoselect=true;self.data.cards.push(resp);callback(null,resp);}).error(callback);};this.purchaseBTC=function(card,amount,callback){var URL='/v2/vogogo/customer/<CUST_ID>/card/<CARD_ID>/buy/btc/';var url=URL.replace('<CUST_ID>',card.cust_id).replace('<CARD_ID>',card.id);self._purchase(url,amount,callback);};this.purchaseUSD=function(card,amount,callback){var URL='/v2/vogogo/customer/<CUST_ID>/card/<CARD_ID>/buy/usd/';var url=URL.replace('<CUST_ID>',card.cust_id).replace('<CARD_ID>',card.id);self._purchase(url,amount,callback);};this._purchase=function(url,amount,callback){$http.post(url,{'amount':amount,'device_id':fingerprintService.fingerprint}).success(function(tx){callback(null,tx);}).error(callback);};this.deleteCard=function(card){var URL='/v2/vogogo/customer/<CUST_ID>/card/<CARD_ID>/';var url=URL.replace('<CUST_ID>',card.cust_id).replace('<CARD_ID>',card.id);$http({'method':'DELETE','url':url}).success(self.reload.bind(self));};this.reload=function(){$http.get('/v2/vogogo/info/').success(function(data){self.data=data;$rootScope.$emit("vogogo:data");});};this.reload();});app.service("browserDetection",["$window",function($window){var mobileAgents=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i;return{isMobile:function(){var ua=$window.navigator.userAgent||$window.navigator.vendor||$window.opera;return mobileAgents.test(ua);}};}]);app.service("gyftService",function($rootScope,$http){var self=this;this.merchants={};this.getDefault=function(){var key=Object.keys(this.merchants)[0];return this.merchants[key];};$http.post("/gyft/available_cards").success(function(data){angular.forEach(data["data"],function(card,cardId){var merchant=self.merchants[card.merchant_name]||{};merchant.name=card.merchant_name;merchant.image=card.cover_image_url_hd;merchant.cards=merchant.cards||[];merchant.cards.push({id:cardId,amount:card.opening_balance});self.merchants[card.merchant_name]=merchant;});$rootScope.$emit("gyft:update");});});app.service("netkiService",["$q","$http",function($q,$http){var RE_DOMAIN=/^(([a-zA-Z]{1})|([a-zA-Z]{1}[a-zA-Z]{1})|([a-zA-Z]{1}[0-9]{1})|([0-9]{1}[a-zA-Z]{1})|([a-zA-Z0-9][a-zA-Z0-9-_]{1,61}[a-zA-Z0-9]))\.([a-zA-Z]{2,6}|[a-zA-Z0-9-]{1,126}\.[a-zA-Z]{2,})$/;var NETKI_URL="https://api.netki.com/api/wallet_lookup/<DOMAIN>/btc";function isValidFormat(domain){return!!RE_DOMAIN.test(domain);}
function getAddress(domain){var deferred=$q.defer();var url=NETKI_URL.replace("<DOMAIN>",domain);$http({method:"GET",url:url,headers:{"X-CSRFToken":undefined}}).success(function(response){if(response&&response.success&&response.currency=="btc"){deferred.resolve(response.wallet_address);}else{deferred.reject("Netki: "+response.message);}}).error(function(){deferred.reject();});return deferred.promise;}
return{isValidFormat:isValidFormat,getAddress:getAddress};}]);app.service('fingerprintService',function($window,jsonStorageService){var self=this;self.fingerprint=jsonStorageService.get('device_id');if(!self.fingerprint){new $window.Fingerprint2().get(function(result){jsonStorageService.put('device_id',result);self.fingerprint=result;});}});app.service('referralsService',["$q","$http","encodingService",function($q,$http,encodingService){var originalFriendsUrl="/v2/friends/Twitter?page_size=9&is_user=false",inviteFriendsUrl="/v2/referrals/";function inviteFriend(friendData){var deferred=$q.defer();$http({method:"POST",url:inviteFriendsUrl,data:encodingService.encode(friendData),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(){deferred.resolve();}).error(function(){deferred.reject();});return deferred.promise;}
function inviteFriends(friendsData){var deferred=$q.defer(),promises=[];angular.forEach(friendsData,function(friend){promises.push(inviteFriend(friend));});$q.all(promises).then(function(){deferred.resolve();});return deferred.promise;}
function setFriendFields(friends){var friendData=[];for(var i=0;i<friends.length;i++){var friend=friends[i],pictureUrl=friend.picture_url||"";friendData.push({fullName:friend.full_name,username:friend.username,pictureUrl:pictureUrl.replace("_normal.","."),channelIconUrl:"/public/img/icon_64_twitter.png"});}
return friendData;}
function getFriends(nextFriendsUrl){var deferred=$q.defer(),friendsUrl=nextFriendsUrl||originalFriendsUrl;$http({method:"GET",url:friendsUrl,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(response){var results=response.results||[],friends=setFriendFields(results);deferred.resolve({nextUrl:response.next,friends:friends});}).error(function(){deferred.reject();});return deferred.promise;}
function getAlreadyReferredFriends(){var deferred=$q.defer();$http({method:"GET",url:inviteFriendsUrl,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(response){var results=response.results||[],alreadyReferredFriends=[];angular.forEach(results,function(result){if(result.status!=='failed'){alreadyReferredFriends.push(result);}});alreadyReferredFriends=setFriendFields(alreadyReferredFriends);deferred.resolve({alreadyReferredFriends:alreadyReferredFriends});}).error(function(){deferred.reject();});return deferred.promise;}
return{getFriends:getFriends,getAlreadyReferredFriends:getAlreadyReferredFriends,inviteFriends:inviteFriends};}]);app.service('accountAuthService',["$q","$http","$cookies","encodingService",function($q,$http,$cookies,encodingService){var root="/v2/contribute/accounts/",register_url=root+"register/",login_url=root+"login/",logout_url=root+"logout/",activate_url=root+"activate/",password_reset_url=root+"password/reset/",password_confirm_url=root+"password/reset/confirm/";function login(data){var deferred=$q.defer();$http({withCredentials:true,method:"POST",url:login_url,data:encodingService.encode(data),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(response){deferred.resolve(response);}).error(function(response){deferred.reject(response);});return deferred.promise;}
function logout(){var deferred=$q.defer();$http({method:"POST",url:logout_url,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(response){deferred.resolve(response);}).error(function(response){deferred.reject(response);});return deferred.promise;}
function register(data){var deferred=$q.defer();$http({method:"POST",url:register_url,data:encodingService.encode(data),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(response){deferred.resolve(response);}).error(function(response){deferred.reject(response);});return deferred.promise;}
function activate(data){var deferred=$q.defer();$http({method:"POST",url:activate_url,data:encodingService.encode(data),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(response){deferred.resolve(response);}).error(function(response){deferred.reject(response);});return deferred.promise;}
function password_reset(){var deferred=$q.defer();$http({method:"POST",url:password_reset_url,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(response){deferred.resolve(response);}).error(function(response){deferred.reject(response);});return deferred.promise;}
function password_confirm(data){var deferred=$q.defer();$http({method:"POST",url:password_confirm_url,data:encodingService.encode(data),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(response){deferred.resolve(response);}).error(function(response){deferred.reject(response);});return deferred.promise;}
return{register:register,activate:activate,password_reset:password_reset,password_confirm:password_confirm,login:login,logout:logout};}]);var app=window.angular.module("changetip.directives",[]),TEMPLATES="/public/templates/";app.directive("checkList",function(){return{scope:{list:"=checkList",value:"@"},link:function(scope,elem){var handler=function(setup){var checked=elem.prop("checked"),index=scope.list.indexOf(scope.value);if(checked&&index==-1){if(setup){elem.prop("checked",false);}else{scope.list.push(scope.value);}}else if(!checked&&index!=-1){if(setup){elem.prop("checked",true);}else{scope.list.splice(index,1);}}};var setupHandler=handler.bind(null,true);var changeHandler=handler.bind(null,false);elem.bind("change",function(){scope.$apply(changeHandler);});scope.$watch("list",setupHandler,true);}};}).directive("appListing",function(){return{restrict:"A",scope:{app:"=",time:"@",fwcols:"="},templateUrl:TEMPLATES+"app_listing.html"};}).directive("appListingHeader",function(){return{restrict:"A",scope:{pss:"="},templateUrl:TEMPLATES+"app_listing_header.html"};}).directive("contactForm",function(){return{restrict:"A",scope:{emailSubject:"@",fromUsername:"@",fromEmail:"@",textPlaceholder:"@"},templateUrl:TEMPLATES+"contact_form.html"};}).directive("tipListing",function(){return{restrict:"A",scope:{tip:"="},templateUrl:TEMPLATES+"tip_listing.html"};}).directive("tipListingMoney",function(){return{restrict:"A",scope:{tip:"=",user:"=",showUsd:"=",headerStyle:"="},templateUrl:TEMPLATES+"tip_listing_money.html?1"};}).directive("listingHeaderWide",function(){return{restrict:"A",scope:{pss:"="},templateUrl:TEMPLATES+"listing_header_wide.html"};}).directive("pcListing",function(){return{restrict:"A",scope:{pss:"=",pc:"="},templateUrl:TEMPLATES+"pc_listing.html"};}).directive("pmtListing",function(){return{restrict:"A",scope:{pss:"=",tx:"="},templateUrl:TEMPLATES+"pmt_listing.html"};}).directive('gifItem',function(){return{restrict:'A',scope:{gif_item:'='},templateUrl:TEMPLATES+'gif_tip_item.html'};}).directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){if(event.which===13){scope.$apply(function(){scope.$eval(attrs.ngEnter);});event.preventDefault();}});};}).directive("stopEvent",function(){return{restrict:"A",link:function(scope,element,attr){element.on(attr.stopEvent,function(e){e.stopPropagation();});}};}).directive("bindHtmlCompile",["$sce","$compile",function($sce,$compile){return{restrict:"A",link:function(scope,element,attrs){scope.$watch(function(){var sanitized=$sce.getTrustedHtml(attrs.bindHtmlCompile);return scope.$eval(sanitized);},function(value){element.html(value);$compile(element.contents())(scope);});}};}]).directive("socialField",["$sce","$document","$timeout","Constants",function($sce,$document,$timeout,Constants){return{restrict:"A",transclude:true,require:"ngModel",templateUrl:TEMPLATES+"social_field.html",scope:{profile:"=socialProfile",field:"@socialField",editorGroup:"@socialEditorGroup",multiLine:"@socialMultiLine",required:"@socialRequired",label:"@socialLabel"},link:function($scope,$element,$attrs,ngModel){$element.on("click",function(ev){ev.stopPropagation();});$scope.editing=false;$scope.socialNetworks=[];function asBoolean(v){if(typeof v==="string"||v===undefined){return((v||"").toLowerCase()=="true");}
return v;}
$scope.$watch("required",function(v){$scope.required=asBoolean(v);});$scope.$watch("multiLine",function(v){$scope.multiLine=asBoolean(v);});$scope.$root.$on("socialfield.open",function(ev,group){if(group==$scope.editorGroup&&$scope.editing){$scope.closeEditor();}});var channels=Constants.get("channels");if($scope.field!==""){angular.forEach(Constants.get("channels"),function(c){if(c.activeForUser&&c.fieldsProvided.indexOf($scope.field)>-1){$scope.socialNetworks.push(c);}});}
ngModel.$render=render;angular.extend($scope,{openEditor:openEditor,saveValue:saveValue,clearValue:clearValue,closeEditor:closeEditor,copyFrom:copyFrom,onKeyUp:onKeyUp});function onKeyUp(ev){if(ev.keyCode==27){closeEditor();}else if(!$scope.multiLine&&ev.keyCode==13){saveValue();closeEditor();}}
function onDocumentClick(){$scope.closeEditor();}
function render(){$scope.value=$sce.trustAsHtml(ngModel.$viewValue||"");}
function openEditor(){$document.on("click",function(){$scope.$apply(onDocumentClick);});$scope.$emit("socialfield.open",$scope.editorGroup);$scope.editing=true;$timeout(function(){if($scope.multiLine){$element.find("textarea")[0].focus();}else{$element.find("input")[0].focus();}},100);}
function clearValue(){$scope.value=null;}
function saveValue(){if($scope.required){if(ngModel.$isEmpty($scope.value)){$scope.value=ngModel.$viewValue;return;}}
ngModel.$setViewValue($scope.value.toString());}
function closeEditor(){$scope.editing=false;$document.off("click",onDocumentClick);}
function copyFrom(channel){var profile=channels[channel.toLowerCase()].profile;if(profile!==undefined){$scope.value=profile[$scope.field]||"";}}}};}]);app.directive("ctShow",["$animate",function($animate){return{scope:{"ctShow":"=","afterShow":"&","afterHide":"&"},link:function(scope,element){scope.$watch("ctShow",function(show){if(show){$animate.removeClass(element,"ng-hide",scope.afterShow);}
if(!show){$animate.addClass(element,"ng-hide",scope.afterHide);}});}};}]);app.directive("fb",["$FB","Constants",function($FB,Constants){return{restrict:"EA",replace:true,scope:{appId:"@",cookie:"@",status:"@",xfbml:"@",version:"@",init:"@"},template:"<div id='fb-root'></div>",compile:function(){return{post:function($scope,$element,$attrs){var fbAppId=$scope.appId||$attrs.fbAppId||"";if(!fbAppId){fbAppId=Constants.get("facebook").app_id;}
var params={appId:fbAppId,cookie:$scope.cookie||$attrs.fbCookie||true,status:$scope.status||$attrs.fbStatus||true,xfbml:$scope.xfbml||$attrs.fbXfbml||true,version:$scope.version||$attrs.fbVersion||"v2.0"};window.fbAsyncInit=function(){$FB._init(params);if($scope.init||$attrs.fbInit){$scope.$eval($attrs.init);}
$scope.$apply(function(){$FB.resolved.resolve($FB);});};(function(document,tagName,id){if(document.getElementById(id)){return;}
var fbjs=document.getElementsByTagName(tagName)[0];var js=document.createElement(tagName);js.id=id;js.async=true;js.src="//connect.facebook.net/en_US/sdk.js";fbjs.parentNode.insertBefore(js,fbjs);})(document,"script","facebook-jssdk");}};}};}]);app.directive("fbFriendSelector",["$FB","TemplateRouter",function($FB,$templates){return{restrict:"E",replace:true,templateUrl:$templates.urlFor("/fb_friend_selector.html"),scope:{friends:"=",profile:"=fbProfile",posttipmssg:"=",title:"@",buttonLabel:"=",onSelect:"=",onClick:"=",onDismiss:"="},link:function($scope){$scope.search="";$scope.selected=[];$scope.multiSelect=false;$scope.showSelected=false;$scope.imageUrlFor=function(profile){if(profile.photo){return profile.photo.data.url;}else{return"//graph.facebook.com/"+profile.id+"/picture";}};$scope.onFriendClick=function(profile){if(!$scope.multiSelect){if($scope.selected.indexOf(profile)>-1){$scope.selected=[];$scope.onClick(null);}else{$scope.selected=[profile];$scope.onClick(profile);}}};$scope.isSelected=function(profile){return $scope.selected.indexOf(profile)>-1;};$scope.selectFriend=function(){if($scope.onSelect($scope.selected)!==false){$scope.selected=[];$scope.search="";$scope.showSelected=false;}};$scope.dismiss=function(ev){ev.preventDefault();$scope.selected=[];$scope.search="";$scope.showSelected=false;$scope.onDismiss();};}};}]);app.directive("modalVideoPlayer",["TemplateRouter","$sce","$document","browserDetection",function($templates,$sce,$document,$browser){return{restrict:"E",replace:true,templateUrl:$templates.urlFor("/modal_video.html"),scope:{playing:"=",url:"="},link:function($scope,$element){var url=$scope.url+"?feature=player_embedded&enablejsapi=1";$scope._trustedUrl=$sce.trustAsResourceUrl(url);$scope.$watch("playing",function(v){if(v){angular.noop();if(!$browser.isMobile()){sendCommand("seekTo","0");$scope.playVideo();}}else{$scope.pauseVideo();}});function handleKeydown(ev){if(ev.which===27){$scope.pauseVideo();$scope.$digest();}}
function handleClick(ev){ev.preventDefault();$scope.pauseVideo();$scope.$digest();}
function sendCommand(c,args){if(!args){args="";}
var iframe=$element.find("iframe")[0];if(iframe){var command={event:"command",func:c,args:""};iframe.contentWindow.postMessage(angular.toJson(command),"*");}}
$scope.pauseVideo=function(){sendCommand("pauseVideo");$scope.playing=false;};$scope.playVideo=function(){sendCommand("playVideo");$scope.playing=true;};$document.bind("keydown",handleKeydown);$element.bind("click",handleClick);}};}]);app.directive("ctRandomBgColor",function(){return{link:function($scope,$element){var classes=["ct-bg-blue","ct-bg-crusta","ct-bg-bittersweet"],randomClass=classes[Math.floor(Math.random()*classes.length)];$element[0].className+=" "+randomClass;}};});app.directive("ctTipworthyLayoutManager",function(){return{controller:function($scope){$scope.currentZIndex=999;this.scope=$scope;}};});app.directive("ctTipworthyLayoutBlock",['$window',function($window){return{restrict:"AE",require:'^ctTipworthyLayoutManager',scope:{currentZIndex:'=currentZIndex'},link:function($scope,$element){var getElsSortedByDescriptionCount=function($els,containerClassName){for(var i=0;i<$els.length;i++){$els[0]=$els[0]||document.createElement("div");}
if(containerClassName==="layout-block-new-post"){return $els;}
return $els.sort(function(a,b){return b.dataset.descriptionCount-a.dataset.descriptionCount;});};var setRandomBgColorClass=function($el){var classes=["tw-bg-blue","tw-bg-orange","tw-bg-red"],randomClass=classes[Math.floor(Math.random()*classes.length)];$el.className+=" "+randomClass;};var setClassNames=function($els,classNames){var i=0,len=$els.length;for(i;i<len;i++){$els[i].className+=" "+classNames[i]+" nth-"+(i+1);}};var setPostClassNames=function($els,containerClassName){$els=getElsSortedByDescriptionCount($els,containerClassName);if(containerClassName==="layout-block-one"){setClassNames($els,["tw-small","tw-small","tw-small","tw-small"]);}else if(containerClassName==="layout-block-two"){setClassNames($els,["tw-x-large","tw-small","tw-small","tw-small"]);}else if(containerClassName==="layout-block-three"){setClassNames($els,["tw-medium","tw-medium","tw-small","tw-small"]);}else if(containerClassName==="layout-block-four"||containerClassName==="layout-block-new-post"){setClassNames($els,["tw-large","tw-small","tw-small","tw-small"]);if(containerClassName!=="layout-block-new-post"){setRandomBgColorClass($els[0]);}}};var setZIndices=function($els,layoutBlockClassName){var currentZIndex=$scope.$parent.currentZIndex,currentEl,i;for(i=0;i<$els.length;i++){currentEl=$els[i]||{};currentEl.dataset=currentEl.dataset||{};currentEl.dataset.smallScreenZIndex=currentZIndex--;}
$els=getElsSortedByDescriptionCount($els,layoutBlockClassName);for(i=0;i<$els.length;i++){currentEl=$els[i]||{};currentEl.dataset=currentEl.dataset||{};currentEl.dataset.largeScreenZIndex=$scope.$parent.currentZIndex--;}};var generateClassName=function(opts){if(opts.newCount>0){return"layout-block-new-post";}else if(opts.smallCount===4){return"layout-block-one";}else if(opts.xLargeCount===1){return"layout-block-two";}else if(opts.xLargeCount===2){return"layout-block-three";}else if(opts.largeCount==1&&opts.medCount==1){return"layout-block-three";}else if(opts.xLargeCount===1&&opts.medCount===1){return"layout-block-three";}else if(opts.medCount===2){return"layout-block-two";}
return"layout-block-four";};var watchBrowserSizeForZIndex=function($els){var isBig=false;$scope.updateInnerWidth=function(){$scope.windowWidth=$window.innerWidth;if($scope.windowWidth>=768){isBig=true;}else{isBig=false;}
for(var i=0;i<$els.length;i++){var $currentEl=$els[i]||document.createElement("div");$currentEl.dataset=$currentEl.dataset||{};$currentEl.style=$currentEl.style||{};var bigZIndex=$currentEl.dataset.largeScreenZIndex,smallZIndex=$currentEl.dataset.smallScreenZIndex;if(isBig){$currentEl.style.zIndex=bigZIndex;}else{$currentEl.style.zIndex=smallZIndex;}}};$scope.updateInnerWidth();angular.element($window).bind('resize',function(){$scope.updateInnerWidth();$scope.$apply();});};var getLayoutBlockClassName=function($els){var newCount=0,smallCount=0,medCount=0,largeCount=0,xLargeCount=0,smallBkpt=250,medBkpt=350,largeBkpt=600;for(var i=0;i<$els.length;i++){var $el=$els[i]||document.createElement("div");$el.dataset=$el.dataset||{};var dCount=$el.dataset.descriptionCount||0;if($el.classList.contains("tw-new-post")){newCount++;}else if(dCount<=smallBkpt){smallCount++;}else if(dCount>smallBkpt&&dCount<=medBkpt){medCount++;}else if(dCount>medBkpt&&dCount<=largeBkpt){largeCount++;}else if(dCount>largeBkpt){xLargeCount++;}}
var className=generateClassName({newCount:newCount,smallCount:smallCount,medCount:medCount,largeCount:largeCount,xLargeCount:xLargeCount});return className;};var posts=$element.children();var layoutBlockClassName=getLayoutBlockClassName(posts);$element[0]=$element[0]||{};$element[0].className+=" "+layoutBlockClassName;setZIndices(posts,layoutBlockClassName);setPostClassNames(posts,layoutBlockClassName);watchBrowserSizeForZIndex(posts);}};}]);app.directive("ctFlip",function(){return{restrict:"AE",link:function($scope,$element){$scope.flipToBack=function(){$scope.editDescription=true;$scope.new_description=$scope.description;$scope.new_receiver_username=$scope.receiver_username;$scope.old_tags=angular.copy($scope.tags);$element[0].classList.add("flipped");};$scope.flipToFront=function(){$element[0].classList.remove("flipped");};$scope.cancelEditPost=function(){$scope.tags=$scope.old_tags;$element[0].classList.remove("flipped");};}};});app.directive("ctScrollAndFix",['$window',function($window){return{restrict:"AE",link:function($scope,$element){var makeElementFixed=function($el,top){$el.css({'position':'fixed','top':top});};var restoreOriginalElementPosition=function($el,pos,top){$el.css({'position':pos,'top':top});};var initCtScrollAndFix=function(){var el=$element[0],$el=$(el),$win=$($window),originalOffsetTop=el.offsetTop,originalPosition=$($el).css('position');$win.scroll(function(){var scrollPos=$win.scrollTop();if(scrollPos>originalOffsetTop){makeElementFixed($el,0);}else if(scrollPos<=originalOffsetTop){restoreOriginalElementPosition($el,originalPosition,originalOffsetTop+'px');}});};initCtScrollAndFix();}};}]);app.directive("ctOverlay",[function(){return{restrict:"AE",link:function($scope,$element){var $overlay=$element.find(".ct-overlay");$scope.toggleOverlay=function(){$overlay.toggleClass("opened");};}};}]);app.directive("ctTipTutorial",['$window',function($window){return{restrict:"AE",link:function($scope,$element){var $tutorialInput=$element.find('.tip-tutorial-input'),$nextBtn=$element.find('.tip-tutorial-next-btn'),termsStr=$tutorialInput.data('terms'),handlesStr=$tutorialInput.data('handles'),termsArray=termsStr.split(" "),handlesArray=handlesStr.split(" "),nextUrl=$element.data('next'),passedTutorial=false;var isTermInUserInput=function(term){var inputVal=$tutorialInput.val();if(inputVal.indexOf(term)>-1){return true;}
return false;};var isOneInUserInput=function(terms){var doesExist=false;angular.forEach(terms,function(term){if(isTermInUserInput(term)){doesExist=true;}});return doesExist;};var areAllInUserInput=function(terms){var allExist=true;angular.forEach(terms,function(term){if(!isTermInUserInput(term)){allExist=false;}});return allExist;};var doesInputPass=function(){if(areAllInUserInput(handlesArray)){if(isOneInUserInput(termsArray)){return true;}}
return false;};$scope.tutorialInputKeydown=function(){if(doesInputPass()){passedTutorial=true;$scope.passedTutorial();}else{passedTutorial=false;$scope.notPassedTutorial();}};$scope.notPassedTutorial=function(){$element.removeClass("ct-tip-tutorial-passed");$nextBtn.addClass("disabled");};$scope.passedTutorial=function(){$element.addClass("ct-tip-tutorial-passed");$nextBtn.removeClass("disabled");};$scope.tutorialNext=function(){if(passedTutorial){$window.location.href=nextUrl;}};}};}]);